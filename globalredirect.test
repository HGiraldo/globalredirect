<?php
// $Id $

  define('ERROR_MESSAGE',     'ERROR<br />Expected Path: !expected_path<br />Expected Status Code: !expected_status<br />Location: !location<br />Status: !status');
  define('SUCCESS_MESSAGE', 'SUCCESS<br />Expected Path: !expected_path<br />Expected Status Code: !expected_status<br />Location: !location<br />Status: !status');

/**
 * @file
 * Global Redirect functionality tests
 */

class GlobalRedirectTestCase extends DrupalWebTestCase {


  public static function getInfo() {
    return array(
      'name' => 'Global Redirect',
      'description' => 'Ensure that Global Redirect functions correctly',
      'group' => 'Global Redirect',
    );
  }

  function setUp() {
    $modules = array_merge(func_get_args(), array('path', 'globalredirect'));
    call_user_func_array(array($this, 'parent::setUp'), $modules);
 }


  public function testGlobalRedirect() {
    $user = $this->drupalCreateUser(array(
      'access content',
      'create page content',
      'create url aliases',
    ));
    $this->drupalLogin($user);

    // Create a dummy node
    $node = array(
      'type' => 'page',
      'title' => 'Test Page Node',
      'path' => 'test-node',
    );

    // Save the node
    $node = $this->drupalCreateNode($node);


    // Array of request => "array of expected data" pairs.
    $test_paths = array(
      '<front>' => array('return-code' => 200),  // "" is the frontpage. Should NOT redirect.
      'node'    => array('return-code' => 301),  // "node" is the default frontpage. Should redirect to base path.
      'node/1'  => array('return-code' => 301),  // "node/1" has been defined above as having an alias ("test-node"). Should 301 redirect to the alias.
    );

    // Foreach of the above, lets check they redirect correctly
    foreach ($test_paths as $request => $expecting) {
      // If the request is for the frontpage, just set the string to blank (we cant have a blank array key)
      if ($request == '<front>') { $request == ''; }

      // Display a message tellingthe user what we're testing
      $this->pass(t('Requesting: !path', array('!path' => url($request, array('alias' => TRUE, 'absolute' => TRUE)))));

      // Do a HEAD request (don't care about the body). The alias=>TRUE is to tell Drupal not to lookup the alias - this is a raw request.
      $this->drupalHead($request, array('alias' => TRUE));

      // Grab the headers from the request
      $headers = $this->drupalGetHeaders(TRUE);

      #$this->pass('<pre>'. check_plain(print_r($headers, TRUE)) .'</pre>');
      #$this->pass('<pre>'. check_plain(print_r($headers[0][':status'], TRUE)) .'</pre>');

      // Build a nice array of results
      $result = array(
        '!expected_path' => ($request == variable_get('site_frontpage', 'node')) ? url('<front>', array('absolute' => TRUE)) : url($request, array('absolute' => TRUE)),
        '!expected_status' => $expecting['return-code'],
        '!location' => isset($headers[0]['location']) ? $headers[0]['location'] : 'N/A',
        '!status' => $headers[0][':status'],
      );


      // First test - is the status as expected? (Note: The expected status must be cast to string for strpos to work)
      if (strpos($result['!status'], (string)$result['!expected_status']) !== FALSE) {
        // Ok, we have a status and the status contains the appropriate response code (eg, 200, 301, 403 or 404).

        // Next test (if expected return code is 301) - is the location set, and is it as expected?
        if ($result['!expected_status'] == 301 && $result['!location'] == $result['!expected_path']) {
          // We have redirect and ended up in the right place - a PASS!!!
          $this->pass(t(SUCCESS_MESSAGE, $result), 'GlobalRedirect');
        }
        elseif ($result['!expected_status'] == 200) {
          // We weren't supposed to redirect - this is good!
          $this->pass(t(SUCCESS_MESSAGE, $result), 'GlobalRedirect');
        }
        else {
          // In this case either the return-code or the returned location is unexpected
          $this->fail(t(ERROR_MESSAGE, $result), 'GlobalRedirect');
        }
      }
      else {
        // The status either wasn't present or was not as expected
        $this->fail(t(ERROR_MESSAGE, $result), 'GlobalRedirect');
      }
    }
  }
}
